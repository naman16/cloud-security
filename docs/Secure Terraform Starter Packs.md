# Secure Terraform Starter Packs For AWS

## Introduction

The rapid adoption of cloud computing has revolutionized how organizations deploy and manage their IT infrastructure. As organizations increasingly migrate workloads to the cloud, they face the challenge of effectively managing complex, distributed, and ephemeral environments across multiple providers and regions. Infrastructure as Code (IaC) has emerged as a critical tool for operating in cloud environments, allowing engineers to define and maintain cloud resources as code. This approach treats infrastructure provisioning and management  similar to software code, enabling consistent, repeatable, and version-controlled deployments. 

Traditional security approaches designed for on-premises infrastructure are often inadequate in addressing the unique risks posed by cloud environments. The distributed and dynamic nature of cloud resources, speed of development and innovation, multi-tenant architectures, and the decentralized operating model has resulted in a complex threat landscape that requires a fundamental shift in building and operating scalable security programs. This paradigm shift has popularized the concepts of paved roads and security guardrails to reduce the security burdens on the developers and in turn, enable them to focus on innovation and driving business value, without compromising on security. Below, I have included some helpful resources to better explain the concepts of paved roads and security guardrails but at a high-level:

* Paved Roads: Originally conceptualized by Netflix, refers to a set of standardized frameworks (e.g., authentication patterns, certificate management, service mesh, etc.), self-service tools, and automated processes that allows developers to focus on their core responsibilities, without worrying about security.  
* Security Guardrails: These are preventive controls, integrated into the development workflows, that define the security boundaries and enforce the developers to operate with them, thereby stopping the release of misconfigured and vulnerable resources into cloud environments. 

Most organizations have some level of implementation for paved roads and / or security guardrails, albeit at varying levels of maturity. In my experience, the focus has been primarily geared towards a) enabling scanning / detection as early in the SDLC as possible and b) ad-how blocking of limited high-risk actions via CI / CD pipeline integrations and organizational policies (e.g., Service Control Policies (SCPs), Organization Policies, Azure Policies). 

Furthermore, most organizations that have a cloud presence, have deployed Cloud-Native Application Protection Platform (CNAPP) that provides them increased visibility into their environments and enables them to identify different classes of issues (Shameless plug \- I recently wrote blog posts on [day 1](https://naman16.github.io/cloud-security/) and [day 2](https://naman16.github.io/cloud-security/Implementing%20CNAPP:%20Day%202%20Focus%20Areas/) focus areas for CNAPP). 

In summary, organizations end up spending the majority of their time setting up and conducting different types of scans (at various stages in the development process) to highlight issues. This is a critical first step for having the right level of visibility and understanding of the environment. However, beyond that, there’s limited effort spent in developing prescriptive guidance / artifacts that is centrally published and easily consumable in a manner that enables developers to just “inherit” security and not spend cycles figuring out the nuances / intricacies of securely configuring services. Due to this, actioning on the insights generated by the different tools and timely / efficiently remediating is still a challenge for a lot of organizations.

* Security teams only want to prescribe requirements, run scans, and report on issues; there’s little effort spent in getting hands dirty in working with the developers and engineers to develop reusable secure artifacts \- “build once, use multiple times”.  
* The CNAPP tools (outside of IaC / policy-as-code (PaC)) are great at scanning and flagging issues but the remediation guidance provided by them are generally specific to CLI or Console. For organizations that are heavy users of IaC, this remediation guidance is of limited use because effort still needs to be put by developers or engineers to research and implement the specific IaC parameters to remediate the issues.

## Solution Overview

Given that a) it is best practice to manage cloud environments using IaC and b) efficient / timely remediation is a challenge for most organizations, in the remainder of this blog, I want to focus on highlighting an automation / solution that leverages Artificial Intelligence (AI) to develop secure and reusable IaC that can potentially help with prevention and remediation of issues in cloud environments. 

I have been thinking about this problem statement for a while now and have always been curious about using large language models (LLMs) to develop secure and reusable IaC. I tried implementing this a few times before but never got satisfactory results for various reasons \- poor approach, broader definition of the problem statement, LLM performance, etc. But in my most recent attempt, the results were impressive. Below, I have shared the results and the source code for anyone to use as well as provided some thoughts on how it can be expanded to generate IaC for different languages, cloud providers, and requirement sets.

For the purposes of this automation, I have used Wiz’s Cloud Configuration Rules (CCR)  (I think they have the best out-of--box policy set) for AWS as the set of requirements that needs to be codified in reusable Terraform modules. I have used Anthropic’s Claude 3.5 Sonnet (via AWS Bedrock) as the LLM to develop the secure Terraform modules. Below is a high-level overview of how the automation works:

![Automation Overview](images/Automation%20Overview.png)




## Testing Results

Once the Terraform modules were generated, I was naturally very excited to test them for configuration accuracy (i.e. understanding Terraform) as well as security. Below are the high-level results from some lightweight testing. 

### Accuracy

I was able to deploy the modules for S3 bucket and DynamoDB table in the first try without making any updates to the Terraform files (except specifying values for the variables). Additionally, I did a manual review of a few other modules and those looked accurate to me as well. Overall, I am hugely impressed by the accuracy of the Terraform generated by the LLM and it definitely has come a long way from my previous attempts from a few months ago.  

### Security Configurations

I scanned all the Terraform files using Wiz CLI and the initial scan results highlighted **CRITICAL: 0, HIGH: 8, MEDIUM: 70, LOW: 45**. On further analysis, I observed that:

* A good number of the issues (22, including 4 HIGH) were associated with CloudWatch.
     * I did not clean up these issues because I see them as less risky as I have generally seen CloudWatch be used more for workload / application monitoring, less for security use-cases.

* Some issues were because the LLM created supporting resources (e.g., RDS clusters) as part of the main resource (e.g., RDS instances), as opposed to reusing the dedicated module for that resource (e.g., RDS cluster). As a result, issues did not exist in the actual RDS cluster module but existed on the RDS cluster resource within the RDS instance module.
     * I updated the prompt to minimize this behavior and was able to address most occurrences, but not all.
     * Below, I have added an example using S3 bucket and ALB to further illustrate how these kinds of situations can be addressed when doing actual implementation.   

* Some of the CCR don’t have a value specified for target native type (i.e. they are null). These rules weren’t pulled down by “wiz-ccr-extractor” and as a result, weren’t fed into the LLM as part of the security requirements for the respective services.
      * I did a quick review and manually fixed up some of these, however, I did not do this for all occurrences.
      * This can be addressed by feeding well-defined requirements to the LLM.
   
* Some CCRs’ names and descriptions did not align with Wiz’s actual detection policy (rego rule). In this scenario, I did not make any updates to the Terraform. For example:
      * Name: RDS Aurora cluster multi-availability zone should be enabled.
      * Description: This rule checks if the RDS Aurora Cluster has Multi-Availability Zone (Multi-AZ) disabled. This rule fails if \`MultiAZ\` is \`false\` or does not exist. RDS Aurora clusters should be configured for multiple AZs to ensure the availability of stored data. Deployment to multiple AZs allows for automated failover in the event of an AZ availability issue and during regular RDS maintenance events. It is recommended, especially for production environments, to create a standby instance by enabling the Multi-AZ deployment feature on the RDS clusters. **Note** See Cloud Configuration Rule \`RDS-024\` to review the RDS Instances not configured with Multi-AZ.
      * Wiz Detection: 'aws\_rds\_cluster\' should have 'engine', 'storage\_type', 'allocated\_storage', 'iops' and 'db\_cluster\_instance\_class' attributes defined.

* Some of the issues (e.g., not using latest versions, not encrypted at rest, etc.) were genuine and I tried addressing the majority of them. 

After updating the modules to address issues that were quick fixes. I rescanned all the Terraform files using Wiz CLI and the results were: **CRITICAL: 0, HIGH: 7, MEDIUM: 58, LOW: 34**. While the number of issues at first glance may seem high, I think that with a) properly defined security requirements and b) well-designed approach for consuming Terraform modules (see below example), the issue counts can be further reduced.

![Terraform Module Reusability - Example](images/Terraform%20Module%20Reusability%20-%20Example.png)




## Closing Thoughts

Even though the focus of this implementation was around developing secure Terraform modules for AWS using Wiz’s CCR as the requirements, this is fairly easy to customize for other IaC languages, cloud providers, and requirements / policy sets to meet your specific use-cases. By updating the LLM prompt and adjusting the plumbing (e.g., changing requirements to that of different CSPs or tools, updating file paths to “azure/” or “gcp/, switching file types from json to csv, etc.), you can extend the functionality of this automation to implement additional use-cases.

With the help of LLM, I was able to create 100+ modules in a matter of a couple hours with reasonable accuracy, which otherwise would have taken someone at least a few weeks to a few months. I am not trying to overhype this or make it sound like a silver bullet. At the end of the day, it is AI generated content and should be taken with a grain of salt when it comes to relevancy and accuracy. However, I am optimistic in what I have seen thus far and it can potentially help engineers save valuable time (since they don’t have to start from scratch when implementing security configurations) and enable security teams to prevent / drive remediation of issues more efficiently.

Resources for paved roads and security guardrails:

1. Netflix’s talk at RSA \- [Construction Time Again: A Lesson in Paving Paths for Security](https://www.rsaconference.com/library/presentation/usa/2023/Construction%20Time%20Again%20A%20Lesson%20in%20Paving%20Paths%20for%20Security?utm_source=appsec.beehiiv.com&utm_medium=referral&utm_campaign=reasonable-appsec-6-five-security-articles-guard-rails-paved-roads-photo-and-podcast-corner)  
2. Google Cloud \- [Building security guardrails for developers](https://cloud.google.com/blog/topics/inside-google-cloud/building-security-guardrails-for-developers-with-google-cloud)  
3. Resourcely’s conversation with Jason Chan \- [Guardrails and Paved Roads](https://www.resourcely.io/post/guardrails-and-paved-roads)  
4. Jason Chan’s talk at LASCON: [From Gates to Guardrails \- Alternate Approaches to Product Security](https://www.youtube.com/watch?v=geumLjxtc54)  
5. Netflix’s blog post \- [The Show Must Go On](https://netflixtechblog.com/the-show-must-go-on-securing-netflix-studios-at-scale-19b801c86479)  
6. Clint Gibler’s chats:
    * [Jason Chan on the Origins of the Paved Road](https://www.youtube.com/watch?v=xijyr54FZn4)
    * [Netflix’s Scott Behrens on the Difficulty of Building a Useful Paved Road](https://www.youtube.com/watch?v=uQaWfTwAWp0)
